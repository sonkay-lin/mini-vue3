{"code":"export let activeEffect;\r\nlet effectStack = []; //目的是为了保证effect执行的时候可以存储正确的关系\r\nexport class ReactiveEffect {\r\n    constructor(fn, scheduler) {\r\n        this.fn = fn;\r\n        this.scheduler = scheduler;\r\n        this.active = true;\r\n        this.parent = null;\r\n        this.deps = []; //记录了依赖了那些属性，同时记录了当前属性依赖了那个effect\r\n    }\r\n    run() {\r\n        if (!this.active) {\r\n            return this.fn();\r\n        }\r\n        //屏蔽同一个effect防止死循环\r\n        // if (effectStack.includes(this)) return\r\n        try {\r\n            // effectStack.push(activeEffect = this)\r\n            // return this.fn()\r\n            // debugger\r\n            this.parent = activeEffect;\r\n            activeEffect = this;\r\n            console.log(this.fn);\r\n            return this.fn();\r\n        }\r\n        finally {\r\n            // effectStack.pop()\r\n            // const n = effectStack.length\r\n            // activeEffect = n > 0 ? effectStack[n - 1] : undefined\r\n            activeEffect = this.parent;\r\n            this.parent = null;\r\n        }\r\n    }\r\n    stop() {\r\n        if (this.active) {\r\n            //清除effect\r\n            this.active = false;\r\n        }\r\n    }\r\n}\r\nconst targetMap = new WeakMap(); //存放所有effect函数\r\n// targetMap: {\r\n//   key: { target },\r\n//   value: {\r\n//     map: {\r\n//       key: 'target[key]',\r\n//       value: set[ ReactiveEffect, ReactiveEffect ]\r\n//     }\r\n//   }\r\n// }\r\n//判断当前属性是否需要收集依赖\r\nexport function isTracking() {\r\n    return activeEffect !== undefined;\r\n}\r\nexport function createDep(effects) {\r\n    const dep = new Set(effects);\r\n    return dep;\r\n}\r\n//收集依赖\r\nexport function track(target, key) {\r\n    //如果属性不依赖于effect return\r\n    if (!isTracking())\r\n        return;\r\n    // debugger\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        //如果depsMap没有值,默认设置为Map并赋值给targetMap\r\n        targetMap.set(target, (depsMap = new Map()));\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set()));\r\n    }\r\n    trackEffects(dep);\r\n}\r\nexport function trackEffects(dep) {\r\n    let shouldTrack = !dep.has(activeEffect);\r\n    //看下这个属性有没有存过这个effect 防止effect中多次调用同一个属性\r\n    if (shouldTrack) {\r\n        dep.add(activeEffect);\r\n        activeEffect.deps.push(dep); //effect依赖了哪些属性\r\n        // console.log(targetMap, activeEffect, shouldTrack, key)\r\n    }\r\n}\r\nexport function trigger(target, key) {\r\n    const depsMap = targetMap.get(target);\r\n    if (!depsMap)\r\n        return;\r\n    console.log(target, key);\r\n    let deps = [];\r\n    if (key !== undefined) {\r\n        deps.push(depsMap.get(key));\r\n    }\r\n    let effects = [];\r\n    for (const dep of deps) {\r\n        if (dep) {\r\n            effects.push(...dep);\r\n        }\r\n    }\r\n    console.log(depsMap, key);\r\n    triggerEffects(createDep(effects));\r\n}\r\nexport function triggerEffects(dep) {\r\n    for (const effect of dep) {\r\n        if (effect !== activeEffect) {\r\n            if (effect.scheduler) {\r\n                console.log('scheduler');\r\n                effect.scheduler();\r\n            }\r\n            else {\r\n                effect.run();\r\n            }\r\n        }\r\n    }\r\n}\r\nexport function effect(fn) {\r\n    const _effect = new ReactiveEffect(fn);\r\n    _effect.run();\r\n    const runner = _effect.run.bind(_effect);\r\n    runner.effect = _effect;\r\n    return runner;\r\n}\r\n//# sourceMappingURL=effect.js.map","references":[],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
