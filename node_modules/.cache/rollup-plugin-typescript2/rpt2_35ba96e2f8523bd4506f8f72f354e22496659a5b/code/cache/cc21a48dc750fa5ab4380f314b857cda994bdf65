{"code":"let effectStack = []; //目的是为了保证effect执行的时候可以存储正确的关系\r\nlet activeEffect;\r\nclass ReactiveEffect {\r\n    constructor(fn) {\r\n        this.fn = fn;\r\n        this.active = true;\r\n        this.deps = []; //记录了依赖了那些属性，同时记录了当前属性依赖了那个effect\r\n    }\r\n    run() {\r\n        if (!this.active) {\r\n            return this.fn();\r\n        }\r\n        if (effectStack.includes(this))\r\n            return; //屏蔽同一个effect防止死循环\r\n        try {\r\n            effectStack.push(activeEffect = this);\r\n            return this.fn(); //取值proxy会执行get方法（依赖收集）\r\n        }\r\n        finally {\r\n            effectStack.pop(); //删除最后一个\r\n            activeEffect = effectStack[effectStack.length - 1];\r\n        }\r\n    }\r\n    stop() {\r\n        if (this.active) {\r\n            cleanupEffect(this);\r\n            this.active = false;\r\n        }\r\n    }\r\n}\r\nfunction cleanupEffect(effect) {\r\n    const { deps } = effect;\r\n    for (let dep of deps) {\r\n        dep.delete(effect);\r\n    }\r\n}\r\n//{ 对象: { 属性: [effect, effect] } }\r\nconst targetMap = new WeakMap();\r\nexport function track(target, key) {\r\n    if (!isTracking())\r\n        return; //如果属性不依赖于effect return\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map())); // { 对象: map{} } 一个属性对应多个effect\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set())); //{ 对象: map{ name: set[] } } 一个effect依赖了多个属性\r\n    }\r\n    let shouldTrack = !dep.has(activeEffect); //看下这个属性有没有存过这个effect\r\n    if (shouldTrack) {\r\n        dep.add(activeEffect); //{ 对象: map{ name: set[effect, effect] } }\r\n        activeEffect.deps.push(dep); //effect对应多个属性\r\n    }\r\n    console.log(targetMap);\r\n}\r\nexport function trigger(target, key) {\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap)\r\n        return;\r\n    let deps = [];\r\n    if (key !== undefined) {\r\n        deps.push(depsMap.get(key));\r\n    }\r\n    let effects = [];\r\n    for (const dep of deps) {\r\n        effects.push(...dep);\r\n    }\r\n    for (const effect of effects) {\r\n        if (effect !== activeEffect) {\r\n            effect.run();\r\n        }\r\n    }\r\n}\r\nexport function isTracking() {\r\n    return activeEffect !== undefined;\r\n}\r\nexport function effect(fn) {\r\n    const _effect = new ReactiveEffect(fn);\r\n    _effect.run();\r\n    let runner = _effect.run.bind(_effect);\r\n    return runner;\r\n}\r\n//# sourceMappingURL=effect.js.map","references":[],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
